{% extends 'base.html' %}

{% block title %}Query History{% endblock %}

{% block content %}
<div class="history-page">
    <h2>Weather Query History</h2>
    <div class="filters">
        <form id="filter-form">
            <div class="filter-group">
                <label for="filter-city">City:</label>
                <input 
                    type="text" 
                    id="filter-city" 
                    name="city" 
                    placeholder="Filter by city name"
                >
            </div>

            <div class="filter-group">
                <label for="filter-date-from">From:</label>
                <input 
                    type="datetime-local" 
                    id="filter-date-from" 
                    name="date_from"
                >
            </div>

            <div class="filter-group">
                <label for="filter-date-to">To:</label>
                <input 
                    type="datetime-local" 
                    id="filter-date-to" 
                    name="date_to"
                >
            </div>

            <button type="submit" class="btn btn-secondary">Apply Filters</button>
            <button type="button" id="clear-filters" class="btn btn-secondary">Clear</button>
            <button type="button" id="export-csv" class="btn btn-primary">Export CSV</button>
        </form>
    </div>

    <div id="loading" class="loading" style="display: none;">
        Loading...
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="results-info" class="results-info"></div>

    <div class="table-container">
        <table id="history-table">
            <thead>
                <tr>
                    <th>City</th>
                    <th>Temperature</th>
                    <th>Description</th>
                    <th>Timestamp</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="history-tbody">
                <!-- Rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

document.addEventListener('DOMContentLoaded', () => {
    loadHistory();
});

document.getElementById('filter-form').addEventListener('submit', (e) => {
    e.preventDefault();
    currentPage = 1; 
    applyFilters();
    loadHistory();
});

document.getElementById('clear-filters').addEventListener('click', () => {
    document.getElementById('filter-form').reset();
    currentFilters = {};
    currentPage = 1;
    loadHistory();
});

document.getElementById('export-csv').addEventListener('click', () => {
    exportToCSV();
});

function applyFilters() {
    currentFilters = {};
    
    const city = document.getElementById('filter-city').value.trim();
    if (city) currentFilters.city = city;
    
    const dateFrom = document.getElementById('filter-date-from').value;
    if (dateFrom) currentFilters.date_from = dateFrom;
    
    const dateTo = document.getElementById('filter-date-to').value;
    if (dateTo) currentFilters.date_to = dateTo;
}

async function loadHistory() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    
    try {
        const params = new URLSearchParams({
            ...currentFilters,
            page: currentPage
        });
        
        const response = await fetch(`{% url "weather:query-history" %}?${params}`);
        
        if (!response.ok) {
            throw new Error('Failed to load history');
        }
        
        const data = await response.json();
        displayHistory(data);
        
    } catch (error) {
        document.getElementById('error').textContent = error.message;
        document.getElementById('error').style.display = 'block';
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function displayHistory(data) {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '';

    const resultsInfo = document.getElementById('results-info');
    resultsInfo.textContent = `Total: ${data.count} queries`;
    
    if (data.results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-results">No queries found</td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    data.results.forEach(query => {
        const row = document.createElement('tr');
        
        const cacheStatus = query.served_from_cache 
            ? '<span class="badge badge-cache">⚡ Cached</span>' 
            : '<span class="badge badge-fresh">Fresh</span>';
        
        row.innerHTML = `
            <td>${escapeHtml(query.city_name)}</td>
            <td>${query.temperature.toFixed(1)}°${query.temperature_unit}</td>
            <td>${escapeHtml(query.weather_description)}</td>
            <td>${new Date(query.timestamp).toLocaleString()}</td>
            <td>${cacheStatus}</td>
        `;
        
        tbody.appendChild(row);
    });

    renderPagination(data);
}

function renderPagination(data) {
    const paginationDiv = document.getElementById('pagination');
    paginationDiv.innerHTML = '';
    
    if (!data.next && !data.previous) {
        return; 
    }
    
    const totalPages = Math.ceil(data.count / 10); 

    if (data.previous) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '← Previous';
        prevBtn.className = 'btn btn-secondary';
        prevBtn.onclick = () => {
            currentPage--;
            loadHistory();
        };
        paginationDiv.appendChild(prevBtn);
    }

    const pageInfo = document.createElement('span');
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    pageInfo.className = 'page-info';
    paginationDiv.appendChild(pageInfo);

    if (data.next) {
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Next →';
        nextBtn.className = 'btn btn-secondary';
        nextBtn.onclick = () => {
            currentPage++;
            loadHistory();
        };
        paginationDiv.appendChild(nextBtn);
    }
}

async function exportToCSV() {
    try {
        const params = new URLSearchParams(currentFilters);
        
        const response = await fetch(`{% url "weather:weather-export" %}?${params}`);
        
        if (!response.ok) {
            throw new Error('Failed to export CSV');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `weather_history_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        alert('Failed to export CSV: ' + error.message);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
